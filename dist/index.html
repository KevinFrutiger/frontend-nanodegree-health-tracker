<!DOCTYPE html> <html> <head> <meta charset="utf-8"> <title>Health Tracker</title> <meta name="description" content="A nutrition calorie counter implementing Backbone.js"> <meta name="viewport" content="width=device-width,initial-scale=1"> <style>html{height:100%;-webkit-text-size-adjust:100%}body{height:100%;font-family:"Helvetica Neue",Helvetica,Arial,sans-serif;margin:0}*{box-sizing:border-box}h1{font-size:2rem;margin:10px 0}h2{font-size:1.4rem;font-weight:400;padding:0 10px}p{margin:0 0 10px}.api-attribution{font-size:.6rem}#health-tracker-app{display:-webkit-flex;display:flex;-webkit-flex-direction:column;flex-direction:column;height:100%;margin:0 auto;max-width:750px;padding:0;width:100%}#header{margin:0 10px;-webkit-flex-shrink:0}#main{height:100%;margin:0 10px;overflow-x:hidden;overflow-y:auto;position:relative}button{background-color:#ddd;border-top:1px solid #a1a1a1;border-right:1px solid #a1a1a1;border-bottom:1px solid #a1a1a1;border-left:1px solid #a1a1a1;cursor:pointer}#search-btn{border-radius:0 4px 4px 0;padding:0;width:40px}input{background-color:#fff;background-image:none;border-radius:4px 0 0 4px;border:1px solid #ccc;box-shadow:inset 0 1px 1px rgba(0,0,0,.075);color:#555;display:block;font-family:inherit;font-size:16px;height:34px;line-height:1.42857143;padding:6px 12px;transition:border-color ease-in-out .15s,box-shadow ease-in-out .15s;width:100%}input:focus{border-color:#66afe9;box-shadow:inset 0 1px 1px rgba(0,0,0,.075),0 0 8px rgba(102,175,233,.6)}.has-error input{border-color:#a32929}.has-error input:focus{box-shadow:0 0 14px #a32929}.has-error input::-webkit-input-placeholder{color:#c87878}.has-error input::-moz-placeholder{color:#c87878}.has-error input:-ms-input-placeholder{color:#c87878}.input-group{display:-webkit-flex;display:flex;-webkit-justify-content:center;justify-content:center;margin-top:20px}#saved-list-container{width:100%}.saved-list-table{border-collapse:collapse;width:100%}.saved-list-table td{border-bottom:1px solid #ddd;border-top:1px solid #ddd;padding:8px 10px}.saved-list-table th{border:none;font-size:1.4rem;padding:10px;text-align:right}.saved-list-table .calories{text-align:right}.remove-item{background:0 0;border:none;color:#ddd;font-size:40px;font-weight:700;padding:0;width:40px}td.remove-item-cell{vertical-align:middle}.brand-name{font-style:italic}#search-list-container{background:#fff;display:none;position:absolute;width:100%;z-index:2}#search-list{list-style-type:none;margin:0;padding:0 0 20px}.search-list-item{border:1px solid #ddd;margin-bottom:-1px}.search-list-item:last-child{border-radius:0 0 4px 4px}.name-content{display:block;margin-bottom:10px}.size-content{display:block}.save-item{background:0 0;border:none;font-family:inherit;font-size:.9rem;height:100%;margin:0;padding:10px;text-align:left;width:100%}.close-list{border-radius:4px 4px 0 0;border:none;color:#8c8c8c;font-size:21px;font-weight:700;margin-top:10px;padding:0;width:100%}@media screen and (min-width:600px){#health-tracker-app{-webkit-flex-direction:row;flex-direction:row;-webkit-justify-content:center;justify-content:center}.input-group{min-width:200px}#header{-webkit-flex-basis:40%;flex-basis:40%}#main{-webkit-flex-basis:50%;flex-basis:50%}}</style> </head> <body> <section id="health-tracker-app"> <header id="header"> <h1>Health Tracker</h1> <div class="api-attribution" role="contentinfo">Powered by <a href="https://www.nutritionix.com/api" target="_blank">Nutritionix API</a></div> <div class="input-group" role="search"> <input id="search-input" class="search-input" aria-label="Search for food item" autofocus> <button id="search-btn" type="button" class="input-addon" aria-label="search"> <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24"><path d="M15.5 14h-.79l-.28-.27C15.41 12.59 16 11.11 16 9.5 16 5.91 13.09 3 9.5 3S3 5.91 3 9.5 5.91 16 9.5 16c1.61 0 3.09-.59 4.23-1.57l.27.28v.79l5 4.99L20.49 19l-4.99-5zm-6 0C7.01 14 5 11.99 5 9.5S7.01 5 9.5 5 14 7.01 14 9.5 11.99 14 9.5 14z"/></svg> </button> </div> </header> <main id="main" role="main"> <div id="search-list-container" role="dialog" aria-label="Search results. Select an item from the list to save."> <button id="search-list-close-btn" type="button" class="close-list" aria-label="Close search results"><span aria-hidden="true">&times;</span></button> <ul id="search-list"></ul> </div> <section id="saved-list-container" tabindex="-1"> <h2>Today’s calories</h2> <table class="saved-list-table"> <thead><tr><th>Total:</th><th id="calorie-total" class="calories">…</th><th class="remove-item"></th></tr></thead> <tbody id="saved-list"></tbody> </table> </section> </main> </section> <script type="text/templates" id="saved-item-template"> <td><span class="brand-name"><%= brand %></span> <span class="food-name"><%= name %></span> (<% (serving_size_qty) ? print('<span class="serving-size">' + serving_size_qty + '</span>&nbsp;<span class="serving-unit">' + serving_size_unit + '</span>') : print('<span class="serving-size">1</span> <span class="serving-unit">serving</span>'); %>)</td><td class="calories" aria-label="<%= calories.toFixed() %> calories"><%= calories.toFixed() %></td><td class="remove-item-cell"><button type="button" class="remove-item" aria-label="Remove food item"><span aria-hidden="true">&times;</span></button></td> </script> <script type="text/templates" id="search-item-template"> <button type="button" class="save-item"><span class="name-content"><span class="brand-name"><%= brand %></span> <span class="food-name"><%= name %></span></span><span class="size-content"><% (serving_size_qty) ? print('<span class="serving-size">' + serving_size_qty + '</span> <span class="serving-unit">' + serving_size_unit + '</span>') : print('<span class="serving-size">1</span> <span class="serving-unit">serving</span>'); %></span></button> </script> <script src="//code.jquery.com/jquery-2.1.4.min.js"></script> <script src="//cdnjs.cloudflare.com/ajax/libs/underscore.js/1.8.3/underscore-min.js"></script> <script src="//cdnjs.cloudflare.com/ajax/libs/backbone.js/1.2.3/backbone-min.js"></script> <script>(function(a,b){"object"==typeof exports&&"function"==typeof require?module.exports=b(require("backbone")):"function"==typeof define&&define.amd?define(["backbone"],function(c){return b(c||a.Backbone)}):b(Backbone)})(this,function(a){function b(){return(65536*(1+Math.random())|0).toString(16).substring(1)}function g(a,b){if(null!=a){var c=a[b];return"function"==typeof c?a[b]():c}}return a.LocalStorage=window.Store=function(a,c){if(!this.localStorage)throw"Backbone.localStorage: Environment does not support localStorage.";this.name=a,this.serializer=c||{serialize:function(a){return function(a){return a===Object(a)}(a)?JSON.stringify(a):a},deserialize:function(a){return a&&JSON.parse(a)}};c=this.localStorage().getItem(this.name);this.records=c&&c.split(",")||[]},function(a,b){for(var c in b)a[c]=b[c]}(a.LocalStorage.prototype,{save:function(){this.localStorage().setItem(this.name,this.records.join(","))},create:function(a){return a.id||0===a.id||(a.id=b()+b()+"-"+b()+"-"+b()+"-"+b()+"-"+b()+b()+b(),a.set(a.idAttribute,a.id)),this.localStorage().setItem(this._itemName(a.id),this.serializer.serialize(a)),this.records.push(a.id.toString()),this.save(),this.find(a)},update:function(a){this.localStorage().setItem(this._itemName(a.id),this.serializer.serialize(a));var b=a.id.toString();return function(a,b){for(var c=a.length;c--;)if(a[c]===b)return 1}(this.records,b)||(this.records.push(b),this.save()),this.find(a)},find:function(a){return this.serializer.deserialize(this.localStorage().getItem(this._itemName(a.id)))},findAll:function(){for(var d,a=[],b=0;b<this.records.length;b++)d=this.records[b],null!=(d=this.serializer.deserialize(this.localStorage().getItem(this._itemName(d))))&&a.push(d);return a},destroy:function(a){this.localStorage().removeItem(this._itemName(a.id));for(var b=a.id.toString(),c=0;c<this.records.length;c++)this.records[c]===b&&this.records.splice(c,1);return this.save(),a},localStorage:function(){return localStorage},_clear:function(){var c,a=this.localStorage(),b=new RegExp("^"+this.name+"-");for(c in a.removeItem(this.name),a)b.test(c)&&a.removeItem(c);this.records.length=0},_storageSize:function(){return this.localStorage().length},_itemName:function(a){return this.name+"-"+a}}),a.LocalStorage.sync=window.Store.sync=a.localSync=function(b,c,d){var f,h,e=g(c,"localStorage")||g(c.collection,"localStorage"),i=a.$?a.$.Deferred&&a.$.Deferred():a.Deferred&&a.Deferred();try{switch(b){case"read":f=null!=c.id?e.find(c):e.findAll();break;case"create":f=e.create(c);break;case"update":f=e.update(c);break;case"delete":f=e.destroy(c)}}catch(j){h=22===j.code&&0===e._storageSize()?"Private browsing is unsupported":j.message}return f?(d&&d.success&&("0.9.10"===a.VERSION?d.success(c,f,d):d.success(f)),i&&i.resolve(f)):(h=h||"Record Not Found",d&&d.error&&("0.9.10"===a.VERSION?d.error(c,h,d):d.error(h)),i&&i.reject(h)),d&&d.complete&&d.complete(f),i&&i.promise()},a.ajaxSync=a.sync,a.getSyncMethod=function(b,c){return c&&c.ajaxSync||!g(b,"localStorage")&&!g(b.collection,"localStorage")?a.ajaxSync:a.localSync},a.sync=function(b,c,d){return a.getSyncMethod(c,d).apply(this,[b,c,d])},a.LocalStorage});</script> <script>var app=app||{};(function(){"use strict";app.FoodItem=Backbone.Model.extend({defaults:{name:"",brand:"",calories:"",serving_size_qty:null,serving_size_unit:null}})})();</script> <script>var app=app||{};(function(){"use strict";var SearchList=Backbone.Collection.extend({model:app.FoodItem});app.searchList=new SearchList})();</script> <script>var app=app||{};(function(){"use strict";var SavedList=Backbone.Collection.extend({model:app.FoodItem,localStorage:new Backbone.LocalStorage("food-items-backbone"),getCalorieTotal:function(){return this.reduce(function(total,model){return total+model.get("calories")},0)}});app.savedList=new SavedList})();</script> <script>var app=app||{};(function(){"use strict";app.SavedItemView=Backbone.View.extend({tagName:"tr",className:"saved-list-item",template:_.template($("#saved-item-template").html()),events:{"click .remove-item":"removeMe"},attributes:{tabindex:"-1"},initialize:function(){this.listenTo(this.model,"change",this.render)},render:function(){return this.$el.html(this.template(this.model.attributes)),this},removeMe:function(){var self=this;this.model.destroy({success:function(model,response){self.remove()}})}})})();</script> <script>var app=app||{};(function(){"use strict";app.SearchItemView=Backbone.View.extend({tagName:"li",className:"search-list-item",template:_.template($("#search-item-template").html()),events:{"click .save-item":"select","keypress .save-item":"select"},initialize:function(){this.listenTo(this.model,"change",this.render)},render:function(){return this.$el.html(this.template(this.model.attributes)),this},select:function(event){"click"!==event.type&&event.which!==app.ENTER_KEY||app.eventBus.trigger("selectSearchItem",this)}})})();</script> <script>var app=app||{};(function(){"use strict";app.AppView=Backbone.View.extend({el:"#health-tracker-app",events:{"keypress #search-input":"searchOnUserInput","focus #search-input":"resetInputFeedback","click #search-btn":"searchOnUserInput","click #search-list-close-btn":"searchCloseButtonClick"},searchFeedbackStrings:{DEFAULT:"Enter name or brand",AJAX_IN_PROGRESS:"Searching...",AJAX_FAIL:"Oops. There was a network error.",EMPTY_INPUT:"Please enter name or brand"},initialize:function(){this.focusNewView=!1,this.$jqXHR=null,this.$searchInput=this.$("#search-input"),this.$searchList=this.$("#search-list"),this.$searchListContainer=this.$("#search-list-container"),this.$searchListCloseButton=this.$("#search-list-close-btn"),this.$savedList=this.$("#saved-list"),this.$savedListContainer=this.$("#saved-list-container"),this.$calorieTotal=this.$("#calorie-total"),this.$searchInput.prop("placeholder",this.searchFeedbackStrings.DEFAULT),this.listenTo(app.searchList,"remove",this.removeSearchList),this.listenTo(app.savedList,"add",this.addSavedItemView),this.listenTo(app.savedList,"update",this.renderCalorieTotal),this.listenTo(app.savedList,"remove",this.focusLastItem),this.listenTo(app.savedList,"reset",this.renderCalorieTotal),this.listenTo(app.eventBus,"selectSearchItem",this.selectSearchItem);var self=this;this.fetching=!0,app.savedList.fetch({success:function(){self.fetching=!1,self.filterTodaysItems()}})},renderCalorieTotal:function(){this.$calorieTotal.text(app.savedList.getCalorieTotal().toFixed())},filterTodaysItems:function(){var todaysModels=_.filter(app.savedList.models,function(model){return new Date(model.get("timestamp")).setHours(0,0,0,0)==(new Date).setHours(0,0,0,0)});app.savedList.reset(todaysModels),_.each(todaysModels,this.addSavedItemView,this)},addSavedItemView:function($el){var self=this;this.fetching||(($el=new app.SavedItemView({model:$el}).render().$el).hide(),this.$savedList.append($el),$el.show(300,function(){self.focusNewView&&(this.focus(),self.focusNewView=!1)}))},focusLastItem:function(){var $lastItem=this.$savedList.children(".saved-list-item").last();(0!==$lastItem.length?$lastItem:this.$savedListContainer).focus()},searchOnUserInput:function(value){value.which===app.ENTER_KEY||"click"===value.type?(value=this.$searchInput.val().trim())?(this.removeSearchList(),this.queryHealthAPI(value),this.$searchInput.val(""),this.$searchInput.prop("placeholder",this.searchFeedbackStrings.AJAX_IN_PROGRESS),this.$searchInput.prop("disabled",!0)):(this.$searchInput.parent().addClass("has-error"),this.$searchInput.prop("placeholder",this.searchFeedbackStrings.EMPTY_INPUT)):this.resetInputFeedback()},resetInputFeedback:function(event){this.$searchInput.parent().removeClass("has-error")},queryHealthAPI:function(value){var self=this;this.$jqXHR=$.ajax({url:"https://api.nutritionix.com/v1_1/search/"+value,dataType:"json",data:{appId:"30fc0f57",appKey:"847b2a751b496a8e6e8c3a2d4f5bc20d",results:"0:20",fields:"*"}}).done(function(data,status,jqXHR){data.hits,self.createSearchList(data.hits),self.$savedListContainer.hide(),self.$searchInput.prop("disabled",!1),self.$searchInput.prop("placeholder",self.searchFeedbackStrings.DEFAULT)}).fail(function(jqXHR,textStatus,errorThrown){self.$searchInput.prop("disabled",!1),self.$searchInput.parent().addClass("has-error"),self.$searchInput.prop("placeholder",self.searchFeedbackStrings.AJAX_FAIL)})},createSearchList:function(results){app.searchList.comparator="brand",results.forEach(function(fields){fields=fields.fields;app.searchList.add(new app.FoodItem({name:fields.item_name,brand:fields.brand_name,calories:fields.nf_calories,serving_size_qty:fields.nf_serving_size_qty,serving_size_unit:fields.nf_serving_size_unit}))}),this.showSearchList()},showSearchList:function(){_.each(app.searchList.models,this.addSearchItemView,this),"none"===this.$searchListContainer.css("display")&&this.$searchListContainer.show(),this.$searchListCloseButton.focus()},addSearchItemView:function(view){view=new app.SearchItemView({model:view});this.$searchList.append(view.render().$el)},selectSearchItem:function(model){this.focusNewView=!0;model=app.searchList.remove(model.model);model.set("timestamp",Date.now()),app.savedList.create(model),this.removeSearchList()},removeSearchList:function(){app.searchList.reset(),this.$searchList.empty(),this.$searchListContainer.hide(),this.$savedListContainer.show()},searchCloseButtonClick:function(event){this.removeSearchList(),this.$searchInput.focus()}})})();</script> <script>var app=app||{};app.ENTER_KEY=13,$(function(){"use strict";app.eventBus=_.extend(Backbone.Events),app.appView=new app.AppView});</script> </body> </html>