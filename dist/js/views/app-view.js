var app=app||{};(function(){"use strict";app.AppView=Backbone.View.extend({el:"#health-tracker-app",events:{"keypress #search-input":"searchOnUserInput","focus #search-input":"resetInputFeedback","click #search-btn":"searchOnUserInput","click #search-list-close-btn":"removeSearchList"},searchFeedbackStrings:{DEFAULT:"Search for food by name or brand",AJAX_IN_PROGRESS:"Searching...",AJAX_FAIL:"Oops. There was a network error.",EMPTY_INPUT:"Please enter food by name or brand"},initialize:function(){this.$jqXHR=null,this.$searchInput=this.$("#search-input"),this.$searchList=this.$("#search-list"),this.$searchListContainer=this.$("#search-list-container"),this.$savedList=this.$("#saved-list"),this.$savedListContainer=this.$("#saved-list-container"),this.$calorieTotal=this.$("#calorie-total"),this.$searchInput.prop("placeholder",this.searchFeedbackStrings.DEFAULT),this.listenTo(app.searchList,"remove",this.removeSearchList),this.listenTo(app.savedList,"add",this.addSavedItemView),this.listenTo(app.savedList,"update",this.renderCalorieTotal),this.listenTo(app.savedList,"reset",this.renderCalorieTotal),this.listenTo(app.eventBus,"selectSearchItem",this.selectSearchItem);var self=this;this.fetching=!0,app.savedList.fetch({success:function(){self.fetching=!1,self.filterTodaysItems()}})},renderCalorieTotal:function(){this.$calorieTotal.text(app.savedList.getCalorieTotal().toFixed())},filterTodaysItems:function(){var todaysModels=_.filter(app.savedList.models,function(model){var date=new Date(model.get("timestamp")).setHours(0,0,0,0),today=(new Date).setHours(0,0,0,0);return date==today});app.savedList.reset(todaysModels),_.each(todaysModels,this.addSavedItemView,this)},addSavedItemView:function(foodItem){if(!this.fetching){var view=new app.SavedItemView({model:foodItem}),$el=view.render().$el;$el.hide(),this.$savedList.append($el),$el.show(300)}},searchOnUserInput:function(event){if(event.which===app.ENTER_KEY||"click"===event.type){var value=this.$searchInput.val().trim();value?(this.removeSearchList(),this.queryHealthAPI(value),this.$searchInput.val(""),this.$searchInput.prop("placeholder",this.searchFeedbackStrings.AJAX_IN_PROGRESS),this.$searchInput.prop("disabled",!0)):(this.$searchInput.parent().addClass("has-error"),this.$searchInput.prop("placeholder",this.searchFeedbackStrings.EMPTY_INPUT))}else this.resetInputFeedback()},resetInputFeedback:function(event){this.$searchInput.parent().removeClass("has-error")},queryHealthAPI:function(value){var self=this;this.$jqXHR=$.ajax({url:"https://api.nutritionix.com/v1_1/search/"+value,dataType:"json",data:{appId:"30fc0f57",appKey:"847b2a751b496a8e6e8c3a2d4f5bc20d",results:"0:20",fields:"*"}}).done(function(data,status,jqXHR){!data.hits,self.createSearchList(data.hits),self.$savedListContainer.hide(),self.$searchInput.prop("disabled",!1),self.$searchInput.prop("placeholder",self.searchFeedbackStrings.DEFAULT)}).fail(function(jqXHR,textStatus,errorThrown){self.$searchInput.prop("disabled",!1),self.$searchInput.parent().addClass("has-error"),self.$searchInput.prop("placeholder",self.searchFeedbackStrings.AJAX_FAIL)})},createSearchList:function(results){app.searchList.comparator="brand",results.forEach(function(result){var fields=result.fields;app.searchList.add(new app.FoodItem({name:fields.item_name,brand:fields.brand_name,calories:fields.nf_calories,serving_size_qty:fields.nf_serving_size_qty,serving_size_unit:fields.nf_serving_size_unit}))}),this.showSearchList()},showSearchList:function(){_.each(app.searchList.models,this.addSearchItemView,this),"none"===this.$searchListContainer.css("display")&&this.$searchListContainer.show()},addSearchItemView:function(foodItem){var view=new app.SearchItemView({model:foodItem});this.$searchList.append(view.render().$el)},selectSearchItem:function(view){var model=app.searchList.remove(view.model);model.set("timestamp",Date.now()),app.savedList.create(model),this.removeSearchList()},removeSearchList:function(){app.searchList.reset(),this.$searchList.empty(),this.$searchListContainer.hide(),this.$savedListContainer.show()}})})();